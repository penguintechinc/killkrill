# Fleet Agent (Orbit) Configuration
# Generated by Ansible for {{ inventory_hostname }}

# Fleet server connection
fleet_url: {{ fleet_server_url }}
enroll_secret: {{ fleet_enroll_secret }}

# Agent identification
host_identifier: hostname
hostname: {{ inventory_hostname }}

# Logging configuration
log_level: {{ fleet_agent_log_level | default('info') }}
log_file: /var/log/orbit/orbit.log

# Update configuration
update_interval: 10s
config_refresh: 10s

# TLS settings
tls_skip_verify: true  # Set to false in production with proper certificates

# Agent settings
disable_tables: []
enable_tables: []

# Osquery configuration
osquery:
  config_refresh: 10
  distributed_interval: 10
  logger_snapshot_event_type: true
  schedule_splay_percent: 10
  events_expiry: 3600

  # Performance settings
  schedule_timeout: 0
  schedule_max_drift: 60

  # Enable various osquery features based on host type
  {% if host_type == 'hypervisor' %}
  # Hypervisor-specific configuration
  disable_events: false
  enable_monitor: true
  {% elif host_type == 'kubernetes_node' %}
  # Kubernetes node-specific configuration
  disable_events: false
  enable_monitor: true
  enable_bpf_events: true
  {% endif %}

# Custom configuration for different host types
{% if host_type == 'hypervisor' %}
# Hypervisor monitoring configuration
hypervisor:
  platform: {{ hypervisor_platform | default('unknown') }}
  monitor_vms: true
  collect_vm_metrics: true
  monitor_storage: true
  monitor_network: true
{% endif %}

{% if host_type == 'kubernetes_node' %}
# Kubernetes node configuration
kubernetes:
  node_role: {{ node_role | default('worker') }}
  monitor_containers: true
  collect_pod_metrics: true
  monitor_cluster_resources: true
{% endif %}

# Integration with KillKrill logging
{% if killkrill_log_receiver is defined %}
log_destinations:
  - type: http
    url: {{ killkrill_log_receiver }}/fleet-logs
    format: json
    headers:
      Authorization: "Bearer {{ fleet_enroll_secret }}"
      Content-Type: "application/json"
{% endif %}

# Fleet desktop (disable for server environments)
desktop_enabled: false

# Orbit auto-update
orbit_update_disabled: false
osqueryd_path: /opt/orbit/bin/osqueryd

# File paths
root_directory: {{ fleet_agent_config_dir }}
cert_path: {{ fleet_agent_config_dir }}/server.pem
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fleet-agent
  namespace: fleet-agents
  labels:
    app.kubernetes.io/name: fleet-agent
    app.kubernetes.io/part-of: killkrill
    app.kubernetes.io/version: "v4.57.0"
    app.kubernetes.io/managed-by: kustomize
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: fleet-agent
  template:
    metadata:
      labels:
        app.kubernetes.io/name: fleet-agent
        app.kubernetes.io/part-of: killkrill
    spec:
      hostNetwork: true
      hostPID: true
      hostIPC: true
      serviceAccountName: fleet-agent
      tolerations:
        # Allow running on all nodes including control plane
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule
        - operator: Exists
          effect: NoExecute
        - operator: Exists
          effect: NoSchedule
      containers:
        - name: fleet-agent
          image: fleetdm/orbit:latest
          imagePullPolicy: Always
          securityContext:
            privileged: true
            runAsUser: 0
            runAsGroup: 0
            capabilities:
              add:
                - SYS_ADMIN
                - SYS_PTRACE
                - SYS_RESOURCE
                - DAC_OVERRIDE
                - SETUID
                - SETGID
                - NET_RAW
                - NET_ADMIN
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: NODE_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            - name: ORBIT_LOG_LEVEL
              value: "info"
            - name: ORBIT_CONFIG_PATH
              value: "/opt/orbit/orbit.yml"
          command:
            - /opt/orbit/bin/orbit/orbit
          args:
            - --config
            - /opt/orbit/orbit.yml
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          volumeMounts:
            - name: config
              mountPath: /opt/orbit/orbit.yml
              subPath: orbit.yml
              readOnly: true
            - name: queries
              mountPath: /opt/orbit/k8s-queries.yml
              subPath: k8s-monitoring-queries.yml
              readOnly: true
            - name: varlog
              mountPath: /var/log/orbit
            - name: host-proc
              mountPath: /host/proc
              readOnly: true
            - name: host-sys
              mountPath: /host/sys
              readOnly: true
            - name: host-etc
              mountPath: /host/etc
              readOnly: true
            - name: host-var
              mountPath: /host/var
              readOnly: true
            - name: host-dev
              mountPath: /host/dev
              readOnly: true
            - name: host-run
              mountPath: /host/run
              readOnly: true
            - name: docker-sock
              mountPath: /var/run/docker.sock
              readOnly: true
            - name: containerd-sock
              mountPath: /run/containerd/containerd.sock
              readOnly: true
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - pgrep orbit >/dev/null
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - pgrep osqueryd >/dev/null
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
      volumes:
        - name: config
          configMap:
            name: fleet-agent-config
            items:
              - key: orbit.yml
                path: orbit.yml
        - name: queries
          configMap:
            name: fleet-agent-config
            items:
              - key: k8s-monitoring-queries.yml
                path: k8s-monitoring-queries.yml
        - name: varlog
          emptyDir: {}
        - name: host-proc
          hostPath:
            path: /proc
            type: Directory
        - name: host-sys
          hostPath:
            path: /sys
            type: Directory
        - name: host-etc
          hostPath:
            path: /etc
            type: Directory
        - name: host-var
          hostPath:
            path: /var
            type: Directory
        - name: host-dev
          hostPath:
            path: /dev
            type: Directory
        - name: host-run
          hostPath:
            path: /run
            type: Directory
        - name: docker-sock
          hostPath:
            path: /var/run/docker.sock
            type: Socket
        - name: containerd-sock
          hostPath:
            path: /run/containerd/containerd.sock
            type: Socket
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
